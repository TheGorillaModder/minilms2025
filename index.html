<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MiniLMS 2025</title>
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup,
             createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // âœ… Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB5tqqvR7UnCEYvSf0PxwcL26aHhin8pw0",
      authDomain: "minilms2025.firebaseapp.com",
      projectId: "minilms2025",
      storageBucket: "minilms2025.appspot.com",
      messagingSenderId: "413157449165",
      appId: "1:413157449165:web:demoappid12345" // <- you can leave this placeholder if not shown in console
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let currentRole = null;

    // UI elements
    const loginDiv = document.getElementById("login");
    const dashboardDiv = document.getElementById("dashboard");
    const roleSelectDiv = document.getElementById("roleSelect");
    const teacherUI = document.getElementById("teacherUI");
    const studentUI = document.getElementById("studentUI");

    // Listen for auth changes
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        loginDiv.style.display = "none";
        roleSelectDiv.style.display = "block";

        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          currentRole = userDoc.data().role;
          roleSelectDiv.style.display = "none";
          showDashboard();
        }
      } else {
        currentUser = null;
        loginDiv.style.display = "block";
        dashboardDiv.style.display = "none";
      }
    });

    // Email signup
    document.getElementById("signupBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      await createUserWithEmailAndPassword(auth, email, password);
    };

    // Email login
    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      await signInWithEmailAndPassword(auth, email, password);
    };

    // Google login
    document.getElementById("googleBtn").onclick = async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };

    // Logout
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.reload();
    };

    // Role select
    document.getElementById("chooseRoleBtn").onclick = async () => {
      const role = document.querySelector('input[name="role"]:checked').value;
      await setDoc(doc(db, "users", currentUser.uid), { role });
      currentRole = role;
      roleSelectDiv.style.display = "none";
      showDashboard();
    };

    function showDashboard() {
      dashboardDiv.style.display = "block";
      if (currentRole === "teacher") {
        teacherUI.style.display = "block";
        studentUI.style.display = "none";
      } else {
        teacherUI.style.display = "none";
        studentUI.style.display = "block";
      }
    }

    // Teacher creates a class
    document.getElementById("createClassBtn").onclick = async () => {
      const className = document.getElementById("className").value;
      await addDoc(collection(db, "classes"), {
        name: className,
        teacher: currentUser.uid
      });
      alert("Class created!");
    };

    // Student joins a class
    document.getElementById("joinClassBtn").onclick = async () => {
      const classCode = document.getElementById("classCode").value;
      const q = query(collection(db, "classes"), where("name", "==", classCode));
      const snap = await getDocs(q);
      if (!snap.empty) {
        await addDoc(collection(db, "enrollments"), {
          student: currentUser.uid,
          class: snap.docs[0].id
        });
        alert("Joined class!");
      } else {
        alert("Class not found.");
      }
    };

    // Teacher uploads assignment
    document.getElementById("uploadAssignmentBtn").onclick = async () => {
      const fileInput = document.getElementById("assignmentFile");
      const file = fileInput.files[0];
      if (!file) { alert("No file chosen"); return; }
      const storageRef = ref(storage, "assignments/" + file.name);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);

      await addDoc(collection(db, "assignments"), {
        teacher: currentUser.uid,
        file: url,
        name: file.name
      });
      alert("Assignment uploaded!");
    };

    // Student submits response
    document.getElementById("submitResponseBtn").onclick = async () => {
      const text = document.getElementById("responseText").value;
      await addDoc(collection(db, "responses"), {
        student: currentUser.uid,
        response: text
      });
      alert("Response submitted!");
    };
  </script>
</head>
<body>
  <div id="login">
    <h2>Login / Signup</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="signupBtn">Signup</button>
    <button id="loginBtn">Login</button>
    <button id="googleBtn">Login with Google</button>
  </div>

  <div id="roleSelect" style="display:none;">
    <h2>Select Role</h2>
    <label><input type="radio" name="role" value="teacher"/> Teacher</label>
    <label><input type="radio" name="role" value="student"/> Student</label>
    <button id="chooseRoleBtn">Continue</button>
  </div>

  <div id="dashboard" style="display:none;">
    <button id="logoutBtn">Logout</button>

    <div id="teacherUI" style="display:none;">
      <h2>Teacher Dashboard</h2>
      <input id="className" placeholder="New Class Name"/>
      <button id="createClassBtn">Create Class</button>
      <br/><br/>
      <input id="assignmentFile" type="file"/>
      <button id="uploadAssignmentBtn">Upload Assignment</button>
    </div>

    <div id="studentUI" style="display:none;">
      <h2>Student Dashboard</h2>
      <input id="classCode" placeholder="Class Name"/>
      <button id="joinClassBtn">Join Class</button>
      <br/><br/>
      <textarea id="responseText" placeholder="Write your response"></textarea>
      <button id="submitResponseBtn">Submit Response</button>
    </div>
  </div>
</body>
</html>
